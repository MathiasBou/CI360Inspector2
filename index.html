<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CI360 Event Inspector</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

  </head>

  <body>

    <!-- eventModal -->
    <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-lg" role="document" style="top: 400px;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="myModalLabel">Event Details 
                <a onclick="toggleFullDetails();" style="font-size: small;">(display/hide all)</a></h4>
          </div>
          <div class="modal-body" style="padding: 0px;" data-dismiss="modal">
              
                <div class="row">
                    <div id="eventDetailsModal" class="col-lg-12">
                    </div>
                </div>
            
          </div>
        </div>
      </div>
    </div><!-- end eventModal -->


    <!-- Modal -->
    <div class="modal fade" id="configModal" tabindex="-1" role="dialog" aria-labelledby="Configuration">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">CI360 Event Inspector Configuration</h4>
          </div>

          <div  class="modal-body"><!-- Nav tabs -->
            
        
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" >
                <a href="#demoCustomers" aria-controls="demoCustomers" role="tab" data-toggle="tab">Demo Customers</a>
            </li>
            <li role="presentation" class="active">
                <a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Settings</a>
            </li>
            <li role="presentation">
                <a href="#esp" aria-controls="esp" role="tab" data-toggle="tab">Integration</a>
            </li>
            <li role="presentation">
                <a href="#help" aria-controls="help" role="tab" data-toggle="tab">Help</a>
            </li>
          </ul>

          <!-- Tab panes -->
          <div class="tab-content">

            <!-- Help Panel -->
            <div role="tabpanel" class="tab-pane" id="help">                
                <div class="row">
                    <div class="col-lg-12">
                        <br>
                        <p > 
                            CI360 Event Inspector is developed by <b>Mathias Bouten</b> 
                            <br><br>
                            This tool is not officially supported by SAS Institute GmbH, it was developed to support
                            demonstrations of SAS Customer Intelligence 360 capabilities.
                            <br><br>
                            If you have any questions or comments you can send an email to: <a href="mailto:mathias.bouten@sas.com?Subject=CI360EventInspector" target="_top">mathias.bouten@sas.com</a>
                        </p>
                        <br>
                    </div>
                </div><!--end row-->
            </div> 
            <!-- end tabpanel -->

            <!-- Customer Panel -->
            <div role="tabpanel" class="tab-pane" id="demoCustomers">                
                <div class="row">
                    <div class="col-lg-12">
                        <br>
                                <div class="text-center" width="20%">
                                    <button type="button" onclick="addCustomer();" 
                                        class="btn btn-sm btn-default editCustomers">
                                        <span class="glyphicon glyphicon-plus"></span> Add Customer
                                    </button>

                                    <button type="button" onclick="exportBtnClick('Customers');" 
                                        class="btn btn-sm btn-default editCustomers">
                                        <span class="glyphicon glyphicon-download"></span> Export Customers
                                    </button>

                                    <button type="button" onclick="editBtnClick('Customers');" 
                                        class="btn btn-sm btn-default expCustomers" style="display:none">
                                        <span class="glyphicon glyphicon-edit"></span> Edit Customers
                                    </button>
                                </div>
                        <br>
                             
                        <div class="editCustomers">
                            <table id="configuratorCustomerTable" class="table table-striped table-hover table-bordered">
                                <thead>
                                  
                                </thead>
                                <tbody id="configuratorCustomerTbody"></tbody>
                            </table>
                        </div>

                        <div class="expCustomers" style="display:none">
                            <br>
                            <p class="text-primary"> Copy and paste the text below into a file to export this configuration!</p>
                            <br>
                            <textarea readonly id="textareaCustomers" type="text" class="form-control" rows="20"></textarea>
                        </div>
                    </div>
                </div><!--end row-->
            </div> 
            <!-- end tabpanel -->

            <!-- Settings Panel -->
            <div role="tabpanel" class="tab-pane active" id="settings">

                <div class="row">
                    <div class="col-lg-12">
                        <br>
                            <div class="text-center" width="20%">
                                <button type="button" onclick="exportBtnClick('Settings');" 
                                        class="btn btn-sm btn-default editSettings">
                                    <span class="glyphicon glyphicon-download"></span> 
                                    Export Settings
                                </button>

                                <button type="button" onclick="editBtnClick('Settings');" 
                                        class="btn btn-sm btn-default expSettings" style="display:none">
                                    <span class="glyphicon glyphicon-edit"></span> 
                                    Edit Settings
                                </button>
                            </div>
                        <br>
                    </div>
                </div>
                
                <div class="row editSettings">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Adjust Timestamp (ms):
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="adjustTimestampInMilliseconds" value="0" type="number" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Label Tab History:
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="label_history" value="" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Label Tab Events:
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="label_events" value="" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Label Tab Clicks:
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="label_clicks" value="" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Label Tab Loads:
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="label_loads" value="" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Label Tab Fields:
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="label_fields" value="" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Label Tab 360 Events:
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="label_360events" value="" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                Label Tab Sessions:
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="label_sessions" value="" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="load" type="checkbox"> load
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">     
                                <input id="eventpara_load" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="click" type="checkbox"> click
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_click" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>
               
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="change" type="checkbox"> change
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_change" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="submit" type="checkbox"> submit
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_submit" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="contentchange" type="checkbox"> contentchange
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">   
                                <input id="eventpara_contentchange" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="IdentityEvent" type="checkbox"> IdentityEvent
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_IdentityEvent" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="jsvarchange" type="checkbox"> jsvarchange
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_jsvarchange" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="jspageerror" type="checkbox"> jspageerror
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_jspageerror" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="spot_change" type="checkbox"> spot_change
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_spot_change" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="spot_viewable" type="checkbox"> spot_viewable
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_spot_viewable" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="spot_clicked" type="checkbox"> spot_clicked
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_spot_clicked" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="DOMContentLoaded" type="checkbox"> DOMContentLoaded
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_DOMContentLoaded" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="unload" type="checkbox"> unload
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_unload" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
                                <input class="settingsCheckbox" id="visibilitychange" type="checkbox"> visibilitychange
                            </label>
                            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">    
                                <input id="eventpara_visibilitychange" value="" type="text" class="settings form-control">
                            </div>
                        </div>
                    </div>

                </div>
                <br>
<!--
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <input class="settingsCheckbox" id="spot_change" type="checkbox"> spot_change
                                <input class="settingsCheckbox" id="spot_viewable" type="checkbox"> spot_viewable
                                <input class="settingsCheckbox" id="spot_clicked" type="checkbox"> spot_clicked
                                <input class="settingsCheckbox" id="DOMContentLoaded" type="checkbox"> DOMContentLoaded
                                <input class="settingsCheckbox" id="unload" type="checkbox"> unload
                                <br>                                
                                
                                <input class="settingsCheckbox" id="visibilitychange" type="checkbox"> visibilitychange
                        </div> 
                    </div>
                </div>
-->
                </div><!-- end edit Settings div -->

                <div class="row expSettings" style="display:none">
                    <div class="col-lg-12">
                        <div class="form-group">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">    
                                <textarea readonly id="textareaSettings" type="text" class="form-control" rows="20"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div> 
            <!-- end tabpanel -->

            <!-- Settings Panel -->
            <div role="tabpanel" class="tab-pane" id="esp">
                
                <div class="row">
                    <br>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group">
                            <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5" >
                                 Enable ESP:
                            </label>
                            <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">  
                                <input onchange="checkEspDisplaySettings();" class="espCheckbox" id="check_espEnabled" type="checkbox">
                            </div>
                        </div>
                    </div>

                    <div id="divEspSettings" style="display:none">
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5" >
                                ESP Host:
                            </label>
                            <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">    
                                <input id="espHost" placeholder="racesxXXXXXX.demo.sas.com" type="text" class=" settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5" >
                                ESP Port (Pub/Sub):
                            </label>
                            <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">    
                                <input id="espPort" value="8081" type="number" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5" >
                                ESP Project/Query:
                            </label>
                            <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">    
                                <input id="espProjectQuery" placeholder="project/continous query" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5" >
                                ESP Source Window:
                            </label>
                            <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">    
                                <input id="espSourceWindow" placeholder="source window name" type="text" class="settings form-control">  
                            </div>
                        </div>
                    </div>
                    </div><!--end divEspSettings -->

                    <br><br>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <br><br>
                        <div class="form-group">
                            <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5" >
                                 Enable RTDM:
                            </label>
                            <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">  
                                <input onchange="checkRtdmDisplaySettings();" class="rtdmCheckbox" id="check_rtdmEnabled" 
                                type="checkbox">
                            </div>
                        </div>
                    </div>
                    <div id="divRtdmSettings" style="display:none">
                        <div class="col-lg-12">
                            <div class="form-group">
                                <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5" >
                                    RTDM Host:
                                </label>
                                <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">  
                                  <div class="input-group">
                                    <span class="input-group-btn">
                                      <button id="rtdmHostButton" name="rtdmHost" type="button" class="btn" 
                                          onclick="onValidateRTDMConnection(this)" style="padding-top: 1px;padding-bottom: 1px;">
                                        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                                      </button>
                                    </span>
                                    <input id="rtdmHost" name="rtdmHost" type="text" class="form-control settings" 
                                      onkeyup="onRtdmHostEnterPress(event, this)" value="sasbap.demo.sas.com">
                                  </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="form-group">
                                <label class="col-lg-5 col-md-5 col-sm-5 col-xs-5">RTDM Event:</label>
                                <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7">
                                  <select id="rtdmEvent" class="rtdmEvent form-control settings">
                                  </select>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div> 
            <!-- end tabpanel -->

          </div> <!-- end tab-content -->


            
        </div><!--end body-->

        <div class="modal-footer">
            <div class="row">
                <div class="col-xs-6">
                    <p class="text-left">Version 2.0.7 (2017-03-01)</p>
                </div>

                <div class="col-xs-6 ">
                    <p class="text-right">
                        <button type="button" class="btn btn-default" 
                            data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" 
                            data-dismiss="modal" onclick="saveConfig();">Save</button>
                    </p>
                </div>
            </div>
        </div><!--end footer-->

        </div>
      </div>
    </div>

    
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <h3><span onclick="displayPopup();" data-toggle="modal" data-target="#configModal">Visitor</span> Profile</h3>
            </div>
        
            <div class="col-xs-12">
                <!--<b>Current Page:</b> <span id="infoCurrentPage">...</span><br/>-->
                <b>Identity:</b> <span class="custAttr" id="infoIdentity"></span><br/>
                <b>Visitor:</b> <span class="custAttr" id="infoVisitor">...</span><br/>
                <b>Session:</b> <span class="custAttr" id="infoSession">...</span><br/>
                <br>
            </div>

            <div class="col-xs-6" id="divCustAttr">
                <!--<b>Name:</b>             <span class="custAttr" id="name">...</span><br/>
                <b>Age:</b>              <span class="custAttr" id="age">...</span><br/>
                <b>Segment:</b>          <span class="custAttr" id="segment">...</span><br/>
                <b>Engagement Score:</b> <span class="custAttr" id="score">...</span><br/>
                <b>Visits Last Week:</b> <span class="custAttr" id="visits">...</span><br/>-->
            </div>

            <div class="col-xs-6">
                <!--Last Update: <span id="infoLastUpdate">...</span><br/>-->
                <b>Last Event:</b>      <span class="custAttr" id="infoLastEvent">...</span><br/>
                <b>Screen:</b>          <span class="custAttr" id="infoScreen">...</span><br/>
                <b>Browser Size:</b>    <span class="custAttr" id="infoBsz">...</span><br/>
                <b>Language:</b>        <span class="custAttr" id="infoLanguage">...</span><br/>
                <b>Platform:</b>        <span class="custAttr" id="infoPlatform">...</span><br/>
                <b>Number of Events:</b> <span class="custAttr" id="infoEvents">...</span><br/>
                <b>Number of Sessions:</b> <span class="custAttr" id="infoSessions">...</span><br/>
                <!--<b>Security:</b> <span id="infoSecurity">...</span><br/>-->
            </div>
            
        </div>

    </div>
    <hr />



    <div><!-- tab navigation -->
      <!-- Nav tabs -->
      <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
            <a href="#history" aria-controls="history" role="tab" 
               data-toggle="tab" id="tab_label_history">History</a></li>
        <li role="presentation">
            <a href="#detailedHistory" aria-controls="detailedHistory" role="tab" 
               data-toggle="tab" id="tab_label_events">All Events</a></li>
        <li role="presentation">
            <a href="#clickHistory" aria-controls="clickHistory" role="tab" 
               data-toggle="tab" id="tab_label_clicks">Clicks</a></li>
        <li role="presentation">
            <a href="#loadHistory" aria-controls="loadHistory" role="tab" 
               data-toggle="tab" id="tab_label_loads">Loads</a></li>
        <li role="presentation">
            <a href="#changeHistory" aria-controls="changeHistory" role="tab" 
               data-toggle="tab" id="tab_label_fields">Field Interactions</a></li>
        <li role="presentation">
            <a href="#ci360History" aria-controls="ci360History" role="tab" 
               data-toggle="tab" id="tab_label_360events">360 Events</a></li>
        <li role="presentation">
            <a href="#sessionHistory" aria-controls="sessionHistory" role="tab" 
               data-toggle="tab" id="tab_label_sessions">Sessions</a></li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content">

        <div role="tabpanel" class="tab-pane active" id="history">

            <!-- Event History -->
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        
                        <h3>Event History</h3>
                        <!--<p><a onclick="clearHistory();">(clear history)</a></p>-->
                        <p>
                            <button onclick="clearHistory();" type="button" class="btn btn-default btn-xs">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                                Clear History
                            </button>
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                    <div id="lastEventsDiagram">
                        <div id="firstEventBubble" class="event-bobble click" onclick="onBubbleClick(this);">
                            <p>...</p>
                        </div>
                        <div id="secoundEventBubble" class="event-bobble load" onclick="onBubbleClick(this);">
                            <p>...</p>
                        </div>
                        <div id="thirdEventBubble" class="event-bobble submit" onclick="onBubbleClick(this);">
                            <p>...</p>
                        </div>
                        <div id="fourthEventBubble" class="event-bobble change" onclick="onBubbleClick(this);">
                            <p>...</p>
                        </div>
                        <div id="fifthEventBubble" class="event-bobble other" onclick="onBubbleClick(this);">
                            <p>...</p>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Event Details -->
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <h3>Event Details</h3>
                        <!--<p><a onclick="toggleFullDetails();">(display/hide all)</a></p>-->
                        <p>
                            <button onclick="toggleFullDetails();" type="button" class="btn btn-default btn-xs">
                            <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                                Toggle Event Details
                            </button>
                        </p>
                    </div>
                    <div id="eventDetails" class="col-lg-12">
                        Event Details (open)
                    </div>
                </div>
            </div>
        </div> <!-- end tab /History --> 

        <div role="tabpanel" class="tab-pane" id="sessionHistory">
            <table class="table table-striped"> 
                <thead> 
                    <tr> 
                        <th>Time</th> 
                        <th>SessionId / VisitorId</th>
                        <th>Identity</th> 
                        <th>PII Data</th>
                    </tr> 
                </thead> 
                <tbody id="tableSessionHistoryBody">  
                </tbody> 
            </table>
        </div> <!-- end tab /sessionHistory -->

        <div role="tabpanel" class="tab-pane" id="detailedHistory">
            <table class="table table-striped"> 
                <thead> 
                    <tr> 
                        <th>
                            <a onclick="reorderEvents();">
                                Time <span class="classEventsOrder"></span>
                            </a>
                        </th> 
                        <th>SessionId / VisitorId</th>
                        <th>Event</th> 
                        <th>Details</th> 
                        <!--<th>URI</th>-->
                    </tr> 
                </thead> 
                <tbody id="tableDetailedHistoryBody">  
                </tbody> 
            </table>
        </div> <!-- end tab /detailedHistory -->

        <div role="tabpanel" class="tab-pane" id="loadHistory">
            <table class="table table-striped"> 
                <thead> 
                    <tr> 
                        <th>
                            <a onclick="reorderEvents();">
                                Time <span class="classEventsOrder"></span>
                            </a>
                        </th>  
                        <th>SessionId / VisitorId</th>
                        <th>Event</th> 
                        <th>Title / URI</th>
                    </tr> 
                </thead> 
                <tbody id="tableLoadHistoryBody">  
                </tbody> 
            </table>
        </div> <!-- end tab /loadHistory -->

        <div role="tabpanel" class="tab-pane" id="clickHistory">
            <table class="table table-striped"> 
                <thead> 
                    <tr> 
                        <th>
                            <a onclick="reorderEvents();">
                                Time <span class="classEventsOrder"></span>
                            </a>
                        </th>  
                        <th>SessionId / VisitorId</th>
                        <th>Event</th> 
                        <th>Title / URI</th>
                    </tr> 
                </thead> 
                <tbody id="tableClickHistoryBody">  
                </tbody> 
            </table>
        </div> <!-- end tab /clickHistory -->

        <div role="tabpanel" class="tab-pane" id="changeHistory">
            <table class="table table-striped"> 
                <thead> 
                    <tr> 
                        <th>
                            <a onclick="reorderEvents();">
                                Time <span class="classEventsOrder"></span>
                            </a>
                        </th>  
                        <th>SessionId / VisitorId</th>
                        <th>Event</th> 
                        <th>Field</th>
                        <th>Value</th> 
                        <th>URI</th> 
                    </tr> 
                </thead> 
                <tbody id="tableChangeHistoryBody">  
                </tbody> 
            </table>
        </div> <!-- end tab /changeHistory -->

        <div role="tabpanel" class="tab-pane" id="ci360History">
            <table class="table table-striped"> 
                <thead> 
                    <tr> 
                        <th>
                            <a onclick="reorderEvents();">
                                Time <span class="classEventsOrder"></span>
                            </a>
                        </th>  
                        <th>Visitor</th>
                        <th>Event</th>
                        <th>Details</th> 
                        <th>Count</th>
                    </tr> 
                </thead> 
                <tbody id="tableCi360HistoryBody">  
                </tbody> 
            </table>
        </div> <!-- end tab /ci360History -->

      </div><!-- end Tab panes -->

    </div><!-- tab navigation end -->

    <script id="configCustomerRow" type="text/x-handlebars-template">
      <tr>
        <td>
          <div class="row">
            <div class="form-group"> 
                <label class="col-lg-3 col-md-3 col-sm-3 col-xs-3" style="margin-top: 20px;">
                    <a style="color:#ca4242" onclick="dropCustomer(this);">
                        <span class="glyphicon glyphicon-remove"></span></a>
                    Identity:
                </label>
            </div>

            <div class="form-group">
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                    <input name="attrIdentity" placeholder="identity value" value="{{identity}}" type="text" class="form-control">  
                </div> 
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1" style="margin-top: 5px;">
                    <a onclick="addAttribute(this);">
                        <span class="glyphicon glyphicon-plus"></span>
                    </a>
                </div>
                <br>
            </div>
          </div>
        </td>
      </tr>
    </script>

    <script id="configAttributeRow" type="text/x-handlebars-template">
        <div name="attribute">
            <div class="form-group">
                <div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">    
                    <input name="attrName" placeholder="Attribute Name" value="{{name}}" type="text" class="form-control">  
                </div>  
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">    
                    <input name="attrValue" placeholder="Attribute Value" value="{{value}}" type="text" class="form-control">  
                </div>
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1" style="margin-top: 5px;">
                    <a style="color:#ca4242" onclick="dropAttribute(this);"><span class="glyphicon glyphicon-remove"></span></a>
                </div>
            </div>
        </div>
    </script>


    <script id="ci360Row" type="text/x-handlebars-template">
        <tr >
            <td >{{eventTimestamp}}</td>
            <td >{{visitor}}</td>
            <td >{{event}}</td>
            <td width="50%">{{eventname}}</td> 
            <td >{{count}}</td>          
        </tr>
    </script>

    <script id="sessionAllRow" type="text/x-handlebars-template">
        <tr>
            <td >{{timestamp}}</td>
            <td >{{sessionid}} <br>
                <p style="color: darkgoldenrod;">&nbsp;&nbsp;&nbsp;{{visitorid}}</p></td>
            <td >
                 {{#if oldidentity}}
                   <strike>{{oldidentity}}</strike><br><p style="{{css}}">{{identity}}</p></td>
                 {{else}} 
                   <p style="{{css}}">{{identity}}</p></td>
                 {{/if}}
            <td ><p style="{{css}}">{{piidata}}</p></td>          
        </tr>
    </script>

    <script id="eventAllRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}" data-toggle="modal" data-target="#eventModal" onclick="openEventModal(this);">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td> 
            <td >{{detailsText}}<br>{{uri}}</td>
            <input type="hidden" name="historyId" value="{{historyId}}">
        </tr>
    </script>

    <script id="eventClickRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}" data-toggle="modal" data-target="#eventModal" onclick="openEventModal(this);">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td>
            <td >{{detailsText}}<br>{{uri}}</td>
            <input type="hidden" name="historyId" value="{{historyId}}">
        </tr>
    </script>

    <script id="eventLoadRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}" data-toggle="modal" data-target="#eventModal" onclick="openEventModal(this);">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td>
            <td >{{detailsText}}<br>{{uri}}</td> 
            <input type="hidden" name="historyId" value="{{historyId}}">
        </tr>
    </script>

    <script id="eventChangeRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}" data-toggle="modal" data-target="#eventModal" onclick="openEventModal(this);">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td>
            <td >{{eventField}}</td> 
            <td >{{eventValue}}</td> 
            <td >{{uri}}</td>    
            <input type="hidden" name="historyId" value="{{historyId}}">       
        </tr>
    </script>


    <script src="js/ext/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="js/ext/jquery-ui.js" type="text/javascript"></script>
    <script src="js/ext/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/ext/handlebars-4.0.5.min.js" type="text/javascript"></script>
    <script src="js/ext/holder.min.js" type="text/javascript"></script>
    <script src="js/ext/jstz.min.js"></script>
    <script src="js/sas_rtdm_esp.minify.js"></script>
    <script src="js/inspector.js" type="text/javascript"></script>
    <script type="text/javascript">

    var exampleCustomerArray = [
{"identity":"761d434c-1a7c-4af4-89ea-23c70e477bd1",
"Name":"Mathias Bouten",
"Email":"mathias.bouten@sas.com",
"Age":"36",
"Gender":"Male",
"Segment":"Small-Family",
"Score":"77"},

{"identity":"08ee2c6f-47e0-3ccd-a21e-3241662de4bc",
"Name":"Mathias Bouten",
"Email":"mathias.bouten@sas.com",
"Age":"36",
"Gender":"Male",
"Segment":"Small-Family",
"Score":"77"},

{"identity":"c6a4ff06-1e8d-44df-9867-bfac85931692",
"Name":"Rob Sneath",
"Email":"rob.sneath@sas.com",
"Age":"41",
"Gender":"Male",
"Segment":"Just-Married",
"Score":"55"},

{"identity":"74f1ab8b-b090-4c86-a856-d1835cddbdcb",
"Name":"Rob Taylor",
"Email":"robj.taylor@sas.com",
"Age":"39",
"Gender":"Male",
"Segment":"Social-Shopper",
"Score":"60"}
];

    var defaultSettingsObject = {
        "adjustTimestampInMilliseconds":"7200000",
        "event_load" : true,
        "eventpara_load" : "event attribution",
        "event_click" : true,
        "eventpara_click" : "event attribution",
        "event_submit" : true,
        "eventpara_submit" : "event attribution",
        "event_change" : true,
        "eventpara_change" : "event attribution",
        "event_contentchange" : true,
        "eventpara_contentchange" : "event attribution",
        "event_IdentityEvent" : true,
        "eventpara_IdentityEvent" : "event attribution",
        "event_jsvarchange" : true,
        "eventpara_jsvarchange" : "name value",
        "event_unload" : false,
        "event_DOMContentLoaded" : false,
        "event_spot_change" : false,
        "event_spot_viewable" : false,
        "event_spot_clicked" : false
    };

    var adjustTime = defaultSettingsObject.adjustTimestampInMilliseconds;

    var htmlTemplates = {};
        $("script[type='text/x-handlebars-template']").each(function(elem) {
            htmlTemplates[this.id] = Handlebars.compile($(this).html());
        });

    var eventHistory = [];
    var aggrEvents = [];
    var sessionHistory = [];
    var demoCustomers = [];
    var rtdmEngine = {host: "sasbap.demo.sas.com"};

    var relevantEvents = {
        "unload":           ["event", "page_title", "referrer", "uri", "^pe_*", "identity"],
        "DOMContentLoaded": ["event", "page_title", "referrer", "uri", "^pe_*", "identity"],
        "spot_change":      ["event", "page_title", "uri", "^pe_*", "identity", "spot_id", "creative_id", "task_id"],
        "spot_viewable":    ["event", "page_title", "uri", "^pe_*", "identity", "spot_id", "creative_id", "task_id"],
        "spot_clicked":     ["event", "page_title", "uri", "^pe_*", "identity", "spot_id", "creative_id", "task_id"],
        "load":             ["event", "page_title", "referrer", "uri", "^pe_*", "identity","attribution"], 
        "click":            ["event", "title", "uri", "targetInnerText", "anchor_href", "identity"], 
        "change":           ["event", "form\\.f\\.[\\w+|-]+$"], 
        "submit":           ["event", "form._h.name","form\\.f\\.[\\w+|-]+$"], 
        "contentchange":    ["target", "value"], 
        "IdentityEvent":    ["event", "title", "uri", "identity"]};

    var displayFullDetails = false;
    var eventsOrder = "newLast";

    if (!localStorage.getItem('CI360Customers')) {
        console.log("item does not exist, will be created");
        localStorage.setItem('CI360Customers', JSON.stringify(exampleCustomerArray));
    } else {
        demoCustomers = loadDemoCustomersFromBrowserStorage();
    }

    if (!localStorage.getItem('CI360Settings')) {
        console.log("CI360Settings item does not exist, will be created");
        localStorage.setItem('CI360Settings', JSON.stringify(defaultSettingsObject));
    } else {
        console.log("CI360Settings item exist");
        settingsObject = loadSettingsFromBrowserStorage();
        if(settingsObject.event_load == undefined) {
            settingsObject.event_load = true;
            settingsObject.eventpara_load = "event page_title referrer uri ^pe_* identity attribution";
        }
        if(settingsObject.event_click == undefined) {
            console.log("event click is undefined");
            settingsObject.event_click = true;
            settingsObject.eventpara_click = "event page_title referrer uri ^pe_* identity attribution";
        }
        if(settingsObject.event_change == undefined) {
            settingsObject.event_change = true;
            settingsObject.eventpara_change = "event page_title referrer uri ^pe_* identity attribution";
        }
        if(settingsObject.event_submit == undefined) {
            settingsObject.event_submit = true;
            settingsObject.eventpara_submit = "event page_title referrer uri ^pe_* identity attribution";
        }
        if(settingsObject.event_contentchange == undefined) {
            settingsObject.event_contentchange = true; 
            settingsObject.eventpara_contentchange = "event page_title referrer uri ^pe_* identity attribution";
        }       
        if(settingsObject.event_IdentityEvent == undefined) {
            settingsObject.event_IdentityEvent = true;
            settingsObject.eventpara_IdentityEvent = "event page_title referrer uri ^pe_* identity attribution";
        }
        localStorage.setItem('CI360Settings', JSON.stringify(settingsObject));
    }


    function updateEventHistoryDiagram() {
        var reverseHistory = eventHistory.slice(-5);
        reverseHistory.reverse();

        for(var i = 0; i < 5; i++) {
                
                var realSelectorId = (4-i);
                var cssSelector = ".event-bobble:eq("+ realSelectorId +")";
            
            if(i < eventHistory.length) {
                
                var realEventId = ((eventHistory.length - 1) -i );

                var eventText = "";
                var info = "";

                /*if(reverseHistory[i].event == "load") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "<b>360 Event</b></br>" + decodeURIComponent(reverseHistory[i].page_title);
                    } else {
                        eventText = "<b>View Page</b></br>" + decodeURIComponent(reverseHistory[i].page_title);
                    }
                }
                else if(reverseHistory[i].event == "click") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "<b>360 Event</b></br>" 
                          + (decodeURIComponent(reverseHistory[i].eventname)).trim().substr(0,15);
                    } else {
                        var clickedItem = (decodeURIComponent(reverseHistory[i].title ? reverseHistory[i].title : reverseHistory[i].targetInnerText)).trim().substr(0,15);
                        eventText = "<b>Click on</b></br>" 
                          + clickedItem;
                    }
                }
                else if(reverseHistory[i].event == "change") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "<b>360 Event</b></br>" 
                            + decodeURIComponent(reverseHistory[i]["eventname"]);

                    } else {
                        var indexFrom = decodeURIComponent(reverseHistory[i].location).lastIndexOf("/")+1;
                        var field = decodeURIComponent(reverseHistory[i].location).substr(indexFrom);
                        var value = decodeURIComponent(reverseHistory[i]["form.f."+field]);
                        eventText = "<b>Field Interaction</b><br> " + field;
                    }
                }
                else if(reverseHistory[i].event == "submit") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "<b>360 Event</b> </br>" 
                            + decodeURIComponent(reverseHistory[i]["eventname"]);
                    } else {
                        eventText = "<b>Form Submit</b><br/>" + decodeURIComponent(reverseHistory[i]["form._h.name"]);
                    }
                }
                else if(reverseHistory[i].event == "contentchange") {

                    eventText = "<b>Content Changed</b><br> " + (reverseHistory[i]["newvalue"] ? reverseHistory[i]["newvalue"] : "");
                } 
                else if(reverseHistory[i].event == "IdentityEvent") {
                    eventText = "<b>Identity Event</b>";
                } 
                else if (reverseHistory[i].event == "DOMContentLoaded") {
                    eventText = "<b>DOM Content Loaded</b>";
                }
                else if(reverseHistory[i].event == "jsvarchange") {
                    eventText = "<b>jsvarchange</b></br>";
                    var jsvar_array = decodeURIComponent(reverseHistory[i]["name"]).split(".");
                    jsvar_array.forEach(function (elem) {
                        eventText += elem + "<br>";
                    });
                }
                else {
                    eventText = "<b>" + reverseHistory[i].event + "</b>";
                }
                */


                var maxTextLength = 50 - (i*5);

                $(cssSelector).html("<p>" + reverseHistory[i].eventText.substr(0,maxTextLength) + "</p>");
                $(cssSelector).attr("onclick", "displayEventDetails(" + realEventId + ",this);" );
                    
            }
            else {
                $(cssSelector).html("<p>...</p>");
                $(cssSelector).attr("onclick", "void;" );    
            }
        }
    }

    function reorderEvents() {
        $('.classEventsOrder').removeClass("glyphicon glyphicon-chevron-up glyphicon-chevron-down");

        if (eventsOrder == "newFirst") {
            eventsOrder = "newLast";
            $('.classEventsOrder').addClass("glyphicon glyphicon-chevron-down");
        } else if (eventsOrder == "newLast") {
            eventsOrder = "newFirst";
            $('.classEventsOrder').addClass("glyphicon glyphicon-chevron-up");
        }
        updateEventHistoryTable();
        updateCi360HistoryTable();
    }

    function addEventAttributes(eventData) {

        if(eventData.event == "load") {
            var pageTitle = decodeURIComponent(eventData.page_title);
            //eventData.eventText = pageTitle;
            if (eventData.eventSource == "webmarketing") {
                eventData.eventText = "<b>360 Event</b></br>" + decodeURIComponent(eventData["eventname"]);
            } else {
                eventData.eventText = "<b>View Page</b></br>" + pageTitle;
            }                   
            eventData.info = "Page viewed " + pageTitle;
        }
        else if(eventData.event == "click") {
            var clickedItem = (decodeURIComponent(eventData.title ? eventData.title : eventData.targetInnerText)).trim().substr(0,30);
            //eventData.eventText = clickedItem;
            if (eventData.eventSource == "webmarketing") {
                eventData.eventText = "<b>360 Event</b></br>" 
                          + (decodeURIComponent(eventData.eventname)).trim().substr(0,15);
            } else {
                eventData.eventText = "<b>Click on</b></br>" + clickedItem;
            }
            eventData.info = "Clicked on " + eventData.anchor_href.substr(0,eventData.anchor_href.indexOf('.'));
        }
        else if(eventData.event == "change") {
            eventData.eventText = decodeURIComponent(eventData.location);
            var indexFrom = eventData.eventText.lastIndexOf("/")+1;
            eventData.eventField = eventData.eventText.substr(indexFrom);
            eventData.eventValue = decodeURIComponent(eventData["form.f."+eventData.eventField]);
            //eventData.eventText = eventData.eventText.substr(indexFrom);
            if (eventData.eventSource == "webmarketing") {
                eventData.eventText = "<b>360 Event</b></br>" + decodeURIComponent(eventData["eventname"]);
            } else {
                eventData.eventText = "<b>Field Interaction</b></br> " + eventData.eventField;
            }
            eventData.info = "Entered value " + eventData.eventValue + " in field " + eventData.eventField;
        }
        else if(eventData.event == "submit") {
            var form_id = decodeURIComponent(eventData["form._h.id"]);
            var form_name = decodeURIComponent(eventData["form._h.name"]);
            console.log("form_name:",form_name);
            //eventData.eventText = "Form Id: " + form_id +", Form Name: " + form_name;
            if (eventData.eventSource == "webmarketing") {
                eventData.eventText = "<b>360 Event</b> </br>" 
                            + decodeURIComponent(eventData["eventname"]);
            } else {
                eventData.eventText = "<b>Form Submit</b></br>" + decodeURIComponent(eventData["form._h.name"]);
            }
            if (form_name != "") {
                eventData.info = "Submitted form (name) " + form_name;
            } else {
                eventData.info = "Submitted form (id) " + form_id;
            }
        }
        else if(eventData.event == "contentchange") { 
            eventData.eventText = "<b>Content Changed</b><br> " + (eventData["newvalue"] ? eventData["newvalue"] : "");
            eventData.info = "Content changed " + (eventData["newvalue"] ? eventData["newvalue"] : "");
        }
        else if(eventData.event == "IdentityEvent") {
            eventData.eventText = "<b>Identity Event</b>";
            eventData.info = "Customer Login / Identity Event";
        } 
        else if (eventData.event == "DOMContentLoaded") {
            eventData.eventText = "<b>DOM Content Loaded</b>";
        }
        else if(eventData.event == "jsvarchange") {
            var jsvar_name = decodeURIComponent(eventData["name"]);
            var jsvar_value = decodeURIComponent(eventData["newvalue"]);
            //eventData.eventText = "" + jsvar_name + " = " + jsvar_value;
            eventData.info = "Variable " + jsvar_name + " changed to value: " + jsvar_value;
            eventData.eventText = "<b>jsvarchange</b></br>";
            var jsvar_array = decodeURIComponent(eventData["name"]).split(".");
            jsvar_array.forEach(function (elem) {
                eventData.eventText += elem + "<br>";
            });
        }
        else {
            eventData.eventText = "<b>" + eventData.event + "</b>";
        }

        if(eventData.referrer.indexOf("oogle") > 0) {
            eventData.attribution = "Search";
        } else if(eventData.referrer.indexOf("acebook") > 0) {
            eventData.attribution = "Social";
        } else if(eventData.referrer == "") {
            eventData.attribution = "Direct";
        } else {
            eventData.attribution = "Direct";
        }

        eventData.detailsText = eventData.eventText.replace(/<b>/g,"").replace(/<\/b>/g,"").replace(/<\/br>/g,": ");

        return eventData;
    }

    function updateEventHistoryTable() {
        var reverseHistory = eventHistory.slice(-50);
        if (eventsOrder == "newFirst") {
            reverseHistory.reverse();
        } 
        
        $('#tableDetailedHistoryBody').html("");
        $('#tableClickHistoryBody').html("");
        $('#tableLoadHistoryBody').html("");
        $('#tableChangeHistoryBody').html("");
        //$('#tableCi360HistoryBody').html("");

        for(var i = 0; i < 50; i++) {  //number of past events to display
            
            if(i < eventHistory.length) {
                
                var realEventId = ((eventHistory.length - 1) -i );

                var eventText = "";

                reverseHistory[i].uri = decodeURIComponent(reverseHistory[i].uri);

                /*if(reverseHistory[i].event == "load") {
                    var pageTitle = decodeURIComponent(reverseHistory[i].page_title);
                    reverseHistory[i].eventText = pageTitle;                   
                    reverseHistory[i].info = "Page viewed " + pageTitle;
                }
                else if(reverseHistory[i].event == "click") {
                    var clickedItem = (decodeURIComponent(reverseHistory[i].title ? reverseHistory[i].title : reverseHistory[i].targetInnerText)).trim().substr(0,30);
                    reverseHistory[i].eventText = clickedItem;
                    reverseHistory[i].info = "Clicked on " + reverseHistory[i].anchor_href.substr(0,reverseHistory[i].anchor_href.indexOf('.'));
                }
                else if(reverseHistory[i].event == "change") {
                    reverseHistory[i].eventText = decodeURIComponent(reverseHistory[i].location);
                    var indexFrom = reverseHistory[i].eventText.lastIndexOf("/")+1;
                    var field = reverseHistory[i].eventText.substr(indexFrom);
                    var value = decodeURIComponent(reverseHistory[i]["form.f."+field]);
                    reverseHistory[i].eventField = field;
                    reverseHistory[i].eventValue = value;
                    reverseHistory[i].eventText = field;

                    reverseHistory[i].info = "Entered value " + value + " in field " + field;
                }
                else if(reverseHistory[i].event == "submit") {
                    var form_id = decodeURIComponent(reverseHistory[i]["form._h.id"]);
                    var form_name = decodeURIComponent(reverseHistory[i]["form._h.name"]);
                    reverseHistory[i].eventText = "Form Id: " + form_id +", Form Name: " + form_name;

                    reverseHistory[i].info = "Submitted form " + form_name;
                }
                else if(reverseHistory[i].event == "contentchange") {
                    reverseHistory[i].eventText = "Content Changed"; 
                    reverseHistory[i].info = "Content changed";
                }
                else if(reverseHistory[i].event == "IdentityEvent") {
                    reverseHistory[i].eventText = "Identity Event";
                    reverseHistory[i].info = "Customer Login / Identity Event";
                } 
                else if(reverseHistory[i].event == "jsvarchange") {
                    var jsvar_name = decodeURIComponent(reverseHistory[i]["name"]);
                    var jsvar_value = decodeURIComponent(reverseHistory[i]["newvalue"]);
                    reverseHistory[i].eventText = "" + jsvar_name + " = " + jsvar_value;
                    reverseHistory[i].info = "Variable " + jsvar_name + " changed to value: " + jsvar_value;
                }*/

                

                var maxTextLength = 50 - (i*5);

                addEventRow(reverseHistory[i]);
            }
            
        }
        $('#infoEvents').html(eventHistory.length);
    }

    function updateCi360HistoryTable() {

        $('#tableCi360HistoryBody').html("");
        var aggrEventHist = aggregateEventHistory(eventHistory);

        if (eventsOrder == "newFirst") {
            aggrEventHist.reverse();
        } 

        for (sid in aggrEventHist) {
            $('#tableCi360HistoryBody').append(htmlTemplates.ci360Row(aggrEventHist[sid]));                 
        }      
    }

    function updateSessionHistory() {
        $('#tableSessionHistoryBody').html("");
        for (sid in sessionHistory) {
            $('#tableSessionHistoryBody').append(htmlTemplates.sessionAllRow(sessionHistory[sid]));                  
        }

        lastSessionid = "";
        numberOfSessions = 0;
        for(s in sessionHistory) {
            if(sessionHistory[s].sessionid != lastSessionid) {
                numberOfSessions++;
                lastSessionid = sessionHistory[s].sessionid;
            }
        }


        $('#infoSessions').html(numberOfSessions);
        
    }

    function trackEvent(eventData) {
        //console.log(" ----- start trackEvent");

        if (eventHistory.length > 0 && eventHistory[eventHistory.length-1].event == "IdentityEvent"
            && eventData.event == "IdentityEvent") {

            console.log("!!! NOT TRACKING EVENT: last AND current event type are Identity Events !!! ");
            console.log("    login_event_type: ", eventData.login_event_type);
            // don't capture event if current and last event are both Identity Events

        } else {
            //console.log(" ----- trackEvent: else", eventData);
            updateUIAggregatedFields(eventData);
        
            // store event only if it is relevant

            if(settingsObject["event_" + eventData.event] == true 
                || settingsObject["event_" + eventData.event] == undefined) {
            //if(relevantEvents.hasOwnProperty(eventData.event)) {
                //console.log(" ----- trackEvent: else2");

                if (settingsObject.adjustTimestampInMilliseconds != undefined) {
                    adjustTime = settingsObject.adjustTimestampInMilliseconds*1;
                }
                eventData.eventTimestamp = (new Date(eventData.timestamp*1+adjustTime)).toISOString().replace('T',' ').replace('Z','');

                
                checkAndUpdateSession(eventData);
                eventData = addEventAttributes(eventData);

                eventData.historyId = eventHistory.length;

                eventHistory.push(eventData);

                if (eventData.eventSource == "webmarketing" 
                    && settingsObject.check_espEnabled == true) {

                    prepEventForESP(eventData);
                    
                }

                if (settingsObject.check_rtdmEnabled == true) {

                    prepEventForRTDM(eventData);
                    
                }

                // store onle last 50 events
                eventHistory = eventHistory.slice(-50);
                localStorage.setItem('CI360InspectorEvents', JSON.stringify(eventHistory));
                
                // update journey
                updateEventHistoryDiagram();
                updateEventHistoryTable();
                updateCi360HistoryTable();
                
                //checkAndUpdateSession(eventData);

                // display details of last event
                var lastEventId = eventHistory.length - 1;
                displayEventDetails(lastEventId);

                $(".event-bobble:eq(4)").removeClass( "other", 500, "easeOutBounce" );
                $(".event-bobble:eq(4)").addClass( "other", 500, "easeOutBounce" );
            }
        
        }
    }

    function aggregateEventHistory(eventHistory) {
        var aggrEvents = [];
        eventHistory.map(function(obj){
            eventFound = false;
            for (idx in aggrEvents) {
                if(aggrEvents[idx].eventname == decodeURIComponent(obj.eventname)
                   && aggrEvents[idx].visitor == obj.visitor) {

                    aggrEvents[idx].count = aggrEvents[idx].count+1;
                    aggrEvents[idx].eventTimestamp = obj.eventTimestamp;
                    aggrEvents[idx].timestamp = obj.timestamp
                    eventFound = true;
                } 
            }
            if (eventFound == false && obj.eventname != undefined) {
                //console.log("event not found ....inserting");
                aggrEvent = {};
                aggrEvent.timestamp = obj.timestamp
                aggrEvent.eventname = decodeURIComponent(obj.eventname);
                aggrEvent.eventTimestamp = obj.eventTimestamp;
                aggrEvent.session = obj.session;
                aggrEvent.visitor = obj.visitor;
                aggrEvent.identity = obj.identity;
                aggrEvent.event = obj.event;
                aggrEvent.count = 1;
                aggrEvents.push(aggrEvent);
            }
        });

        aggrEvents.sort(function (a, b) {
          if (a.timestamp > b.timestamp) {
            return 1;
          }
          if (a.timestamp < b.timestamp) {
            return -1;
          }
          // a must be equal to b
          return 0;
        });

        return aggrEvents;
        
    }

    function addEventRow(lastEvent) {

        if ((lastEvent.eventSource != undefined && lastEvent.eventSource == 'webmarketing' )
             || lastEvent.event == "IdentityEvent") {
             
            lastEvent.eventText = lastEvent.event == "IdentityEvent" ? "Customer Login" : decodeURIComponent(lastEvent.eventname);
            lastEvent.eventname = decodeURIComponent(lastEvent.eventname);

        } else if (lastEvent.event == 'click') {
            lastEvent.colorClass = "success";
            $('#tableClickHistoryBody').append(htmlTemplates.eventClickRow(lastEvent));
        } else if (lastEvent.event == 'load') {
            lastEvent.colorClass = "info";
            $('#tableLoadHistoryBody').append(htmlTemplates.eventLoadRow(lastEvent));
        } else if (lastEvent.event == 'change') {
            lastEvent.colorClass = "active";
            $('#tableChangeHistoryBody').append(htmlTemplates.eventChangeRow(lastEvent));
        }   

        //always add all events to the all events tab table
        $('#tableDetailedHistoryBody').append(htmlTemplates.eventAllRow(lastEvent));    
    }

    function loadPreviousEvents() {
        sessionHistory = JSON.parse(localStorage.getItem('CI360InspectorSessions') ? localStorage.getItem('CI360InspectorSessions') : "[]");

        eventHistory = JSON.parse(localStorage.getItem('CI360InspectorEvents') ? localStorage.getItem('CI360InspectorEvents') : "[]");

        aggrEvents = JSON.parse(localStorage.getItem('CI360InspectorAggrEvents') ? localStorage.getItem('CI360InspectorAggrEvents') : "[]");

        for(eventId in eventHistory) {
            updateUIAggregatedFields(eventHistory[eventId], eventId);
        }
        // update journey
        updateEventHistoryDiagram();
        updateEventHistoryTable();
        updateCi360HistoryTable();
        updateSessionHistory();
    }



    function updateUIAggregatedFields(eventData) {
        $("#infoLastUpdate").html(timeConverter(parseInt(eventData.timestamp)));
        $("#infoLastEvent").html(decodeURIComponent(eventData["event"]));

        if(eventData.event === "load") {
            $("#infoIdentity").html(decodeURIComponent(eventData["identity"]));
            $("#infoVisitor").html(decodeURIComponent(eventData["visitor"]));
            $("#infoSession").html(decodeURIComponent(eventData["session"]));
            $("#infoSecurity").html(decodeURIComponent(eventData["protocol"]));
            $("#infoScreen").html(decodeURIComponent(eventData["screen_info"]));
            $("#infoBsz").html(decodeURIComponent(eventData["bsz"]));
            $("#infoLanguage").html(decodeURIComponent(eventData["browser_language"]));
            $("#infoPlatform").html(decodeURIComponent(eventData["platform"]));
            $("#infoCurrentPage").html(decodeURIComponent(eventData["page_title"]));
        }

        //update customer attributes
            var customer = getCustomer(eventData.identity);
            if (customer.identity != undefined) {
                $("#divCustAttr").html("");
                for (attr in customer) {
                    if(attr != "identity" && attr != "tenant") {
                        $('#divCustAttr').append("<b>" +attr+":</b> "+customer[attr]+"<br/>");
                    }
                }
            }
    }



    function displayEventDetails(eventId, elem) {
        settingsObject = loadSettingsFromBrowserStorage();
        
        var relevantParameters = {};
        for (var prop in settingsObject) {
            if (prop.indexOf("eventpara_") > -1) {
                //initialize array
                relevantParameters[prop.split("eventpara_")[1]] = [];

                //check if first element is empty
                if (settingsObject[prop].split(" ")[0] != "") {
                    relevantParameters[prop.split("eventpara_")[1]] = settingsObject[prop].split(" ");
                }

                //add form fields with reg expression
                if (prop == "eventpara_submit" || prop == "eventpara_change") {
                    relevantParameters[prop.split("eventpara_")[1]].push("form\\.f\\.[\\w+|-]+$");
                }

                // add standard parameters to show as relevant parameters
                relevantParameters[prop.split("eventpara_")[1]].push("page_title", "referrer", "uri", "^pe_*" ); 
            }
        }
        //console.log("relevantParameters: ", relevantParameters);


        var eventDetailsSelector = "#eventDetails";
        if (elem != "Modal") {
            $('#firstEventBubble').removeClass("highlight");
            $('#secoundEventBubble').removeClass("highlight");
            $('#thirdEventBubble').removeClass("highlight");
            $('#fourthEventBubble').removeClass("highlight");
            $('#fifthEventBubble').removeClass("highlight");

            $(elem).addClass("highlight");
        } else {
            eventDetailsSelector = "#eventDetailsModal";
        }


        var resultHtml = "<table class=\"table table-striped\">";
        for(prop in eventHistory[eventId]) {

            if (prop != "eventText" && prop != "detailsText") { //dont show eventText parameter
                var isImportant = false;
                if(relevantParameters.hasOwnProperty(eventHistory[eventId].event)) {
                    for (selector of relevantParameters[eventHistory[eventId].event]) {
                        var regEx = new RegExp(selector, "g");
                        isImportant = regEx.test(prop);
                        if(isImportant) {
                            break;
                        }
                    }
                }
                resultHtml += "<tr class=\"" + (isImportant ? "highlighted" : "details") + "\" ><td>" + prop + " </td>  <td><pre>" + decodeURIComponent(eventHistory[eventId][prop]) + "</pre></td> </tr>";
            }
        }

        resultHtml +="</table>";

        $(eventDetailsSelector).html(resultHtml);
        if(!displayFullDetails) {
            $("tr.details").hide();
        }
    }


    function toggleFullDetails() {
        if(displayFullDetails) {
            displayFullDetails = false;
            $("tr.details").hide();
        } else {
            displayFullDetails = true;
            $("tr.details").show();
        }
    }

    function openEventModal(elem) {
        var histId = $(elem).find("input[name='historyId']").val();

        displayFullDetails = false;
        $("tr.details").hide();
        
        displayEventDetails(histId, "Modal");
    }


    function clearHistory(){
        eventHistory = [];
        sessionHistory = [];

        localStorage.setItem('CI360InspectorEvents', "[]");
        localStorage.setItem('CI360InspectorSessions', "[]");
        localStorage.setItem('CI360InspectorAggrEvents', "[]");
        $("#eventDetails").html("");
        updateEventHistoryDiagram();
        updateEventHistoryTable();
        updateSessionHistory();
        updateCi360HistoryTable();
        clearVisitorProfileFields();
        displayEmptyCustomerAttributes();
    }

    function clearVisitorProfileFields() {
        $(".custAttr").html("...");
    }

    function timeConverter(UNIX_timestamp){
        return (new Date(UNIX_timestamp)).toGMTString()
    }

    function parseData(dataString) {
        var pairs = dataString.split("&");
        var objects = pairs.map(function(item) { parts = item.split("="); if(parts.length > 0) { var obj = {}; obj[parts[0]] = parts.slice(1).join("="); return obj};})
        var result = objects.reduce(function(resultObj,currentValue,currentIndex,arr) { for(attr in currentValue) resultObj[attr] = currentValue[attr]; return resultObj}, {});
        return result;
    }


    function processCustomerAttributes(attributesObj) {
        for(attr in attributesObj) {
            console.log("Setting #"+attr+" to " +attributesObj[attr]);
            $("#" + attr).html(attributesObj[attr]);
            session.identity = attributesObj[attr];
            session.piidata = "None";

            //display customer attributes
            var customer = getCustomer(attributesObj[attr]);

            if (customer.identity != undefined) {
                $("#divCustAttr").html("");
                for (attr in customer) {
                    if(attr != "identity" && attr != "tenant") {
                        $('#divCustAttr').append("<b>" +attr+":</b> "+customer[attr]+"<br/>");
                    }
                }
            }
        }
    }

    function checkAndUpdateSession(eventData) {

        var session = {}; 
        session.sessionid = ""; 
        session.identity = "";
        session.css = "";
        session.piidata = "None";
        session.event = "default";
        session.updated = false;

        session.sessionid = eventData.session;
        session.visitorid = eventData.visitor;
        session.identity  = eventData.identity;
        session.timestamp = eventData.eventTimestamp;

        var lastSession = {};
        if (sessionHistory.length > 0) {
            lastSession = sessionHistory[sessionHistory.length-1];
        }   

        var lastEvent = {};
        if (eventHistory.length > 0) {
            lastEvent = eventHistory[eventHistory.length-1];
        }

        // check if datahubid has changed and last sessionid is equals current sessionid
        // then update session history
        if (lastEvent.identity !== undefined && lastEvent.identity !== eventData.identity
            && lastSession.sessionid == eventData.session) {
            console.log("    ---> NEW IDENTITY FOUND ...updating.... ---");
            console.log("      -- last event identity: ", lastEvent.identity);
            console.log("      -- current event identity: ", eventData.identity);

            session.event = "IdentityEvent";
            //session.piidata = decodeURIComponent(eventData.login_event);
            session.piidata = getLoginFromLastIdentityEvent();
            session.oldidentity = lastEvent.identity;
            session.css = "color:orangered";

            // add session (because of identity change) to sessionHistory
            sessionHistory.push(session);
            logSession(session.event, eventData, eventData.uri, session.piidata, demoCustomers);
            
            // update sessionHistory Array
            for (idx in sessionHistory) {
                if (sessionHistory[idx].identity == session.oldidentity
                    && sessionHistory[idx].updated == false) {
                    sessionHistory[idx].oldidentity = sessionHistory[idx].identity;
                    sessionHistory[idx].identity = session.identity;
                    sessionHistory[idx].updated = true;
                }
            }
        }

        // check if it is a complete new session
        // then update session history
        else if (session.sessionid != undefined && session.sessionid.length > 0) {

            var isNotSameSession = true;
            for (sid in sessionHistory) {
                if(session.sessionid == sessionHistory[sid].sessionid) {
                    isNotSameSession = false;
                }       
            }

            if(isNotSameSession == true) {
                console.log("!!! is not same session...adding new session !!!");
                
                // add session (because it is a new session) to sessionHistory
                sessionHistory.push(session);
                logSession(eventData.event, eventData, eventData.uri, "", demoCustomers);
            }           
        }

        localStorage.setItem('CI360InspectorSessions', JSON.stringify(sessionHistory));
        updateSessionHistory();
        
    }

    function getLoginFromLastIdentityEvent() {
        var reverseEventHistory = eventHistory.slice();
        reverseEventHistory.reverse();
        var identityEvent = {};
        for (idx in reverseEventHistory) {
            eventObj = reverseEventHistory[idx];
            if (eventObj.event == "IdentityEvent") {
                identityEvent = eventObj;
                break;
            }
        }
        return decodeURIComponent(identityEvent.login_event);
    }

    function getCustomer(customerIdentifier) {
        var returnCustomerObj = {};
        for (customerIndex in demoCustomers) {
            customer = demoCustomers[customerIndex];
            if (customer.identity == customerIdentifier) {
                returnCustomerObj = customer;
                break;
            }
        }
        return returnCustomerObj;
    }

    function displayPopup() {
        
        // get Customer Object
        if (!localStorage.getItem('CI360Customers')) {
            console.log("item does not exist");
        } else {
            demoCustomers = loadDemoCustomersFromBrowserStorage();

            customerString = JSONstringifyWithLineBreak(demoCustomers);
            $('#textareaCustomers').val(customerString);

            $("#configuratorCustomerTbody").html("");
            demoCustomers.map(function(obj) { addCustomer(null, obj) });
        }

        // get Settings Object
        if (!localStorage.getItem('CI360Settings')) {
            console.log("CI360Settings item does not exist");
        } else {
            settingsObject = loadSettingsFromBrowserStorage();
            settingsString = JSONstringifyWithLineBreak(settingsObject);

            //$('#adjustTimestampInMilliseconds').val(settingsObject.adjustTimestampInMilliseconds);

            for (var prop in settingsObject) {
                //console.log(" property in settingsObject: " + prop);
                if (prop.indexOf("event_") > -1) {
                    // prop enthält "event_" - daher splitten und zweites element [1] nehmen
                    $('#' + prop.split("event_")[1]).prop("checked",settingsObject[prop]);
                } else if (prop.indexOf("check_") > -1) {
                    // prop enthält "check_" - daher splitten und zweites element [1] nehmen
                    $('#' + prop).prop("checked",settingsObject[prop]);
                }
                else {
                    $('#' + prop).val(settingsObject[prop]);
                }
            }

            $('#textareaSettings').val(settingsString);
        }
        checkEspDisplaySettings();
        checkRtdmDisplaySettings();
    }

    function displayEmptyCustomerAttributes() {
        demoCustomers = loadDemoCustomersFromBrowserStorage();

        $('#divCustAttr').html("");
        for (attr in demoCustomers[0]) {
            if(attr != "identity" && attr != "tenant") {
                $('#divCustAttr').append("<b>" +attr+":</b> ...<br/>");
            }
        }
    }

    function updateLabels() {
        settingsObject = loadSettingsFromBrowserStorage();

        if (settingsObject.label_history)   $("#tab_label_history").html(settingsObject.label_history); 
        if (settingsObject.label_events)    $("#tab_label_events").html(settingsObject.label_events); 
        if (settingsObject.label_clicks)    $("#tab_label_clicks").html(settingsObject.label_clicks); 
        if (settingsObject.label_fields)    $("#tab_label_fields").html(settingsObject.label_fields);
        if (settingsObject.label_loads)     $("#tab_label_loads").html(settingsObject.label_loads);
        if (settingsObject.label_360events) $("#tab_label_360events").html(settingsObject.label_360events);
        if (settingsObject.label_sessions)  $("#tab_label_sessions").html(settingsObject.label_sessions);
    }

    function prepEventForESP(eventData) {
        var espUrl = "http://" + settingsObject.espHost + ":" + settingsObject.espPort 
                + "/inject/" + settingsObject.espProjectQuery + "/" + settingsObject.espSourceWindow + "?blocksize=1";

        console.log("  send 360 event to ESP: ",espUrl );
                    
        var eventObject = eventData;
        eventObject.eventname = decodeURIComponent(eventObject.eventname);
        eventObject.page_title = decodeURIComponent(eventObject.page_title);

        //send to ESP Server
        sendEventToESPProxy("http://dachgpci01.emea.sas.com/ESPServiceAdapter/", espUrl, eventObject).done(
        function(result) {
            if (result.search("injected") > 0) {
                console.log("    ESP Send Success");
            } else {
                console.log("    ESP Send Failed");
            }
        });
    }

    function prepEventForRTDM(eventData) {
        //var eventObject = eventData;
        
        eventData.eventname = decodeURIComponent(eventData.eventname);
        eventData.page_title = decodeURIComponent(eventData.page_title);
        eventData.referrer = decodeURIComponent(eventData.referrer);
        var rtdmRequestInputs = eventData; 
        var stringcustid = getCustomer(eventData.identity).customerid ? getCustomer(eventData.identity).customerid : "0";  
        var customerid = parseInt(stringcustid);
           
            rtdmRequestInputs['customerid'] = customerid;
        

        console.log("  send 360 event to RTDM: ", rtdmRequestInputs);
        
        sendRequestToRTDM(rtdmEngine.host, settingsObject.rtdmEvent, rtdmRequestInputs).success(
            function (response) {
                console.log("    RTDM Send Success");
            }).error(function (response) {
                console.log("    RTDM Send Failed");
        });
    }


    /***** API calls *****/
    function logSession(eventtype, eventObject, detail1, detail2, demoCustomers) {
        return callApi({action: 'logSession',
            demoCustomers: demoCustomers,
            detail1: detail1,
            detail2: detail2,
            eventtype: eventtype,
            eventdata: eventObject
        });
    }

    function callApi(parameters) {
        var apiUrl = window.location.protocol + "//" + window.location.host + "/CI360Inspector2/api/";
        return $.ajax(apiUrl, {
            type: 'POST',
            data: parameters
        } );
    }

    function sendEventToESPProxy(proxyUrl, espUrl, eventObject) {
        if(espUrl == "") {
            return;
        }

        espUrl += "?blocksize=1&quiesce=false";

        if(eventObject.opcode == undefined) {
            eventObject.opcode   = "i";
        }

        var eventBlock = [[eventObject]];
        var eventJSON  = JSON.stringify(eventBlock);
        var proxyRequestData = {espRequestUrl: espUrl, espRequestData: eventJSON};

        return $.post(proxyUrl, proxyRequestData);
    }
    /***** API calls *****/


    /*** Configurator Functions ***/
    function addCustomer(elem, customerObj) {
        var position = $("#configuratorCustomerTbody > tr").length+1;
        var newEntry = customerObj == undefined || customerObj.identity == undefined;

        var newCustomerEntry = {identity: "please enter identity value"};

        // render template and append to table
        if(newEntry) {
            $("#configuratorCustomerTbody").prepend(htmlTemplates.configCustomerRow(newCustomerEntry));
        } else {
            $("#configuratorCustomerTbody").append(htmlTemplates.configCustomerRow(customerObj));
            
            for (var prop in customerObj) {
                var attributeObj = {};
                if (prop != "identity") {
                    attributeObj[prop] = customerObj[prop];
                    addAttribute(null,attributeObj, position);
                }
            }
        }
        return newCustomerEntry;
    }

    function dropCustomer(elem) {
        return $(elem).parents('tr').remove();
    }

    function addAttribute(elem, attributeObj, position) {
        var newEntry = attributeObj == undefined;    
        var attrNameValuePair = {};

        for (var prop in attributeObj) {
            attrNameValuePair.name = prop;
            attrNameValuePair.value = attributeObj[prop];
        }

        if(newEntry) {
            $(elem).parents("td").append(htmlTemplates.configAttributeRow(attributeObj));
        } else {
            $("#configuratorCustomerTbody > tr:nth-child("+position+") > td").append(htmlTemplates.configAttributeRow(attrNameValuePair));
        }     
    }

    function dropAttribute(elem) {
        console.log("drop Attribute: ", $(elem).parents("div.form-group"));
        $(elem).parents("div.form-group").remove();
    }

    function getCustomersFromUi() {
        var customerList = [];
        var position = 0;

        $("#configuratorCustomerTbody tr").each(function() {
          
            /* increase table row position and retrieve all customer attributes */
            position++; 
            var custAttr = $("#configuratorCustomerTbody tr:nth-child("+position+") td div[name=attribute]");

            var customerObj = {};
            customerObj.identity = $(this).find("input[name='attrIdentity']").val();
            
            /* get attribute name value pair and store into customer object */
            custAttr.each(function() {
                var attrName = $(this).find("input[name='attrName']").val();
                var attrValue = $(this).find("input[name='attrValue']").val();
                if (attrName != undefined && attrName != "") {
                    customerObj[attrName] = attrValue; 
                }
            });

            /* only store customer object if identity value is set */
            if (customerObj.identity != "" && customerObj.identity != "please enter identity value") {
                customerList.push(customerObj);
            }
        });

        return customerList;
    } 

    function getSettingsFromUi() {
        var settings = {};

        $('.settings').map(function() {
            settings[$(this).attr('id')] = $(this).val() ? $(this).val().trim() : "";
        });

        $('.settingsCheckbox').map(function() {
            settings["event_" + $(this).attr('id')] = $(this).prop("checked");
        });

        $('.espCheckbox').map(function() {
            settings[$(this).attr('id')] = $(this).prop("checked");
        });

        $('.rtdmCheckbox').map(function() {
            settings[$(this).attr('id')] = $(this).prop("checked");
        });

        return settings;
    }

    function exportBtnClick(elementName) {
        $('.exp' + elementName).show();
        $('.edit' + elementName).hide();
    }

    function editBtnClick(elementName) {
        $('.exp' + elementName).hide();
        $('.edit' + elementName).show();
    }

    function saveConfig() {
        /* create settings object */
        settingsObject = getSettingsFromUi();
        customerObject = getCustomersFromUi();
        
        //settingsObject.adjustTimestampInMilliseconds = $('#adjustTimestampInMilliseconds').val();
        console.log("settingsObject: ", settingsObject);

        /* store configuration into local browser storage */
        localStorage.setItem('CI360Customers', JSONstringifyWithLineBreak(customerObject));
        localStorage.setItem('CI360Settings', JSONstringifyWithLineBreak(settingsObject));
        updateLabels();
        displayEmptyCustomerAttributes();
    }

    function loadSettingsFromBrowserStorage() {
        return JSON.parse(localStorage.getItem('CI360Settings') ? localStorage.getItem('CI360Settings') : "{}");
    }

    function loadDemoCustomersFromBrowserStorage() {
        return JSON.parse(localStorage.getItem('CI360Customers') ? localStorage.getItem('CI360Customers') : "[]");
    }

    function JSONstringifyWithLineBreak(object) {
        return JSON.stringify(object).replace(/,/g,",\n").replace(/{/g,"\n{").replace(/]/g,"\n]");
    }

    function checkEspDisplaySettings() {
        if ($('#check_espEnabled').prop("checked") == true) {
            $("#divEspSettings").show();
        } else {
            $("#divEspSettings").hide();
        }
    }

    function checkRtdmDisplaySettings() {
        if ($('#check_rtdmEnabled').prop("checked") == true) {
            $("#divRtdmSettings").show();
        } else {
            $("#divRtdmSettings").hide();
        }

        option = "<option value='"+ settingsObject['rtdmEvent'] + "'>" + settingsObject['rtdmEvent'] +"</option>";
        $('#rtdmEvent').append(option);
    }

    function onRtdmHostEnterPress(e, elem) {
        if (e.keyCode == 13) {
            onValidateRTDMConnection(elem);
        }
    }

    function onValidateRTDMConnection(elem) {
        rtdmEngine.host = $("#rtdmHost").val();

        var jqElem = $('#' +elem.name+'Button');
        jqElem.removeClass("btn-green");
        jqElem.removeClass("btn-fail");

        queryRTDMEvents(rtdmEngine, updateRTDMEventSelections).success(function (elem) {
            jqElem.addClass("btn-green");
            //$('.rtdmEvent').val(settingsObject.rtdmEvent);
        }).error(function (elem) {
            jqElem.addClass("btn-fail");
            $('.rtdmEvent').html("");
            $('.rtdmEvent').val(settingsObject.rtdmEvent);
        });
    }

    function updateRTDMEventSelections() {    
        var options = "<option> -- Select Event -- </option>";
        for(event of rtdmEngine.events) {
            if (!event.decisionId.startsWith("TS_") &&
                 !event.decisionId.startsWith("AE_") &&
                  !event.decisionId.startsWith("_SAS") ) {

                options += "<option value='"+ event.decisionId + "'>" + event.decisionId +"</option>";
            }
        }
        $('.rtdmEvent').html(options);
        $('.rtdmEvent').val(settingsObject.rtdmEvent);
    }
    /*** Configurator Functions ***/


    $( document ).ready(function() {
        
        loadPreviousEvents();
        displayEmptyCustomerAttributes();
        updateLabels();

        window.addEventListener('message', function(event) {
            // The data sent with postMessage is stored in event.data
            console.log("Recieved Event from CI360...");

            if(event.data !== undefined && event.data.type !== undefined) {
                //console.dir(parseData(event.data.payload));

                if(event.data.type == "tracking") {
                    trackEvent(parseData(event.data.payload));
                }

                else if(event.data.type == "heartbeat") {
                    console.log("Communication to main window established.");
                }

                else if(event.data.type == "customer-attribute") {
                    //console.log("Getting customer attribute: "); 
                    //console.dir(parseData(event.data.payload));
                    processCustomerAttributes(parseData(event.data.payload));
                }

                else if(event.data.type == "customer-login") {
                    
                }
                
            } else {
                console.log("No data received");
            }
            
        });
    });
    </script>
  </body>
</html>


