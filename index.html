<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CI360 Event Inspector</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
  </head>

  <body>


    <!-- Modal -->
    <div class="modal fade" id="configModal" tabindex="-1" role="dialog" aria-labelledby="Configuration">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Configuration</h4>
          </div>

          <div  class="modal-body">
            
        <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#demoCustomers" aria-controls="demoCustomers" role="tab" data-toggle="tab">Demo Customers</a></li>
            <li role="presentation">
                <a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Settings</a></li>
          </ul>

          <!-- Tab panes -->
          <div class="tab-content">

            <!-- Customer Panel -->
            <div role="tabpanel" class="tab-pane active" id="demoCustomers">
                <div class="container">
                    <div class="row">
                      <div class="col-lg-12">
                        
                        <form class="form-horizontal">
                            <div class="form-group">
                              <label for="textareaCustomers" class="col-sm-2 control-label"></label>
                              <div class="col-sm-10">
                                <!--<input name="custName" type="text" class="form-control" placeholder="" value=""/>-->
                                <textarea id="textareaCustomers" type="text" class="form-control" rows="30"></textarea>
                              </div>
                            </div>
                        </form>
                        
                      </div><!-- end column-->
                    </div><!--end row-->
                </div>
            </div> <!-- end tabpanel -->

            <!-- Settings Panel -->
            <div role="tabpanel" class="tab-pane" id="settings">
                <div class="container">
                    <div class="row">
                        <div class="col-xs-12">

                          <form class="form-horizontal">
                            <div class="form-group">
                              <label for="textareaSettings" class="col-sm-2 control-label"></label>
                              <div class="col-sm-10">
                                <!--<input name="custName" type="text" class="form-control" placeholder="" value=""/>-->
                                <textarea id="textareaSettings" type="text" class="form-control" rows="30"></textarea>
                              </div>
                            </div>
                          </form>
                        
                        </div>
                    </div>
                </div>
            </div> <!-- end tabpanel -->

          </div> <!-- end tab-content -->


            
          </div><!--end body-->

          <div class="modal-footer"><!--end body-->
            <div class="row">
                <div class="col-xs-6">
                    Version 2.0 (last updated 2016-10-04)
                </div>

                <div class="col-xs-6">
                    <button type="button" class="btn btn-default" 
                            data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" 
                            data-dismiss="modal" onclick="saveCustomerObj();">Save</button>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <h3><span onclick="displayPopup();" data-toggle="modal" data-target="#configModal">Visitor</span> Profile</h3>
            </div>
        
            <div class="col-xs-12">
                <!--<b>Current Page:</b> <span id="infoCurrentPage">...</span><br/>-->
                <b>Identity:</b> <span class="custAttr" id="infoIdentity"></span><br/>
                <b>Visitor:</b> <span class="custAttr" id="infoVisitor">...</span><br/>
                <b>Session:</b> <span class="custAttr" id="infoSession">...</span><br/>
                <br>
            </div>

            <div class="col-xs-6" id="divCustAttr">
                <!--<b>Name:</b>             <span class="custAttr" id="name">...</span><br/>
                <b>Age:</b>              <span class="custAttr" id="age">...</span><br/>
                <b>Segment:</b>          <span class="custAttr" id="segment">...</span><br/>
                <b>Engagement Score:</b> <span class="custAttr" id="score">...</span><br/>
                <b>Visits Last Week:</b> <span class="custAttr" id="visits">...</span><br/>-->
            </div>

            <div class="col-xs-6">
                <!--Last Update: <span id="infoLastUpdate">...</span><br/>-->
                <b>Last Event:</b>      <span class="custAttr" id="infoLastEvent">...</span><br/>
                <b>Screen:</b>          <span class="custAttr" id="infoScreen">...</span><br/>
                <b>Browser Size:</b>    <span class="custAttr" id="infoBsz">...</span><br/>
                <b>Language:</b>        <span class="custAttr" id="infoLanguage">...</span><br/>
                <b>Platform:</b>        <span class="custAttr" id="infoPlatform">...</span><br/>
                <b>Number of Events:</b> <span class="custAttr" id="infoEvents">...</span><br/>
                <b>Number of Sessions:</b> <span class="custAttr" id="infoSessions">...</span><br/>
                <!--<b>Security:</b> <span id="infoSecurity">...</span><br/>-->
            </div>
            
        </div>

    </div>
    <hr />


<!-- tab navigation -->
<div>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active">
        <a href="#history" aria-controls="history" role="tab" 
           data-toggle="tab">History</a></li>
    <li role="presentation">
        <a href="#detailedHistory" aria-controls="detailedHistory" role="tab" 
           data-toggle="tab">All Events</a></li>
    <li role="presentation">
        <a href="#clickHistory" aria-controls="clickHistory" role="tab" 
           data-toggle="tab">Click</a></li>
    <li role="presentation">
        <a href="#loadHistory" aria-controls="loadHistory" role="tab" 
           data-toggle="tab">Load</a></li>
    <li role="presentation">
        <a href="#changeHistory" aria-controls="changeHistory" role="tab" 
           data-toggle="tab">Field Interaction</a></li>
    <li role="presentation">
        <a href="#ci360History" aria-controls="ci360History" role="tab" 
           data-toggle="tab">360 Events</a></li>
    <li role="presentation">
        <a href="#sessionHistory" aria-controls="sessionHistory" role="tab" 
           data-toggle="tab">Sessions</a></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">

    <div role="tabpanel" class="tab-pane active" id="history">

        <!-- Event History -->
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    
                    <h3>Event History</h3>
                    <p><a onclick="clearHistory();">(clear history)</a></p>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                <div id="lastEventsDiagram">
                    <div id="firstEventBubble" class="event-bobble click">
                        <p>...</p>
                    </div>
                    <div id="secoundEventBubble" class="event-bobble load">
                        <p>...</p>
                    </div>
                    <div id="thirdEventBubble" class="event-bobble submit">
                        <p>...</p>
                    </div>
                    <div id="fourthEventBubble" class="event-bobble change">
                        <p>...</p>
                    </div>
                    <div id="fifthEventBubble" class="event-bobble other">
                        <p>...</p>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Event Details -->
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h3>Event Details</h3>
                    <p><a onclick="toggleFullDetails();">(display/hide all)</a></p>
                </div>
                <div id="eventDetails" class="col-lg-12">
                    Event Details (open)
                </div>
            </div>

        </div>


    </div> <!-- end tab /History --> 

    <div role="tabpanel" class="tab-pane" id="sessionHistory">
        <table class="table table-striped"> 
            <thead> 
                <tr> 
                    <th>Time</th> 
                    <th>SessionId / VisitorId</th>
                    <th>Identity</th> 
                    <th>PII Data</th>
                </tr> 
            </thead> 
            <tbody id="tableSessionHistoryBody">  
            </tbody> 
        </table>
    </div> <!-- end tab /sessionHistory -->

    <div role="tabpanel" class="tab-pane" id="detailedHistory">
        <table class="table table-striped"> 
            <thead> 
                <tr> 
                    <th>
                        <a onclick="reorderEvents();">
                            Time <span class="classEventsOrder"></span>
                        </a>
                    </th> 
                    <th>SessionId / VisitorId</th>
                    <th>Event</th> 
                    <th>Details</th> 
                    <!--<th>URI</th>-->
                </tr> 
            </thead> 
            <tbody id="tableDetailedHistoryBody">  
            </tbody> 
        </table>
    </div> <!-- end tab /detailedHistory -->

    <div role="tabpanel" class="tab-pane" id="loadHistory">
        <table class="table table-striped"> 
            <thead> 
                <tr> 
                    <th>
                        <a onclick="reorderEvents();">
                            Time <span class="classEventsOrder"></span>
                        </a>
                    </th>  
                    <th>SessionId / VisitorId</th>
                    <th>Event</th> 
                    <th>Title / URI</th>
                </tr> 
            </thead> 
            <tbody id="tableLoadHistoryBody">  
            </tbody> 
        </table>
    </div> <!-- end tab /loadHistory -->


    <div role="tabpanel" class="tab-pane" id="clickHistory">
        <table class="table table-striped"> 
            <thead> 
                <tr> 
                    <th>
                        <a onclick="reorderEvents();">
                            Time <span class="classEventsOrder"></span>
                        </a>
                    </th>  
                    <th>SessionId / VisitorId</th>
                    <th>Event</th> 
                    <th>Title / URI</th>
                </tr> 
            </thead> 
            <tbody id="tableClickHistoryBody">  
            </tbody> 
        </table>
    </div> <!-- end tab /clickHistory -->

    <div role="tabpanel" class="tab-pane" id="changeHistory">
        <table class="table table-striped"> 
            <thead> 
                <tr> 
                    <th>
                        <a onclick="reorderEvents();">
                            Time <span class="classEventsOrder"></span>
                        </a>
                    </th>  
                    <th>SessionId / VisitorId</th>
                    <th>Event</th> 
                    <th>Field</th>
                    <th>Value</th> 
                    <th>URI</th> 
                </tr> 
            </thead> 
            <tbody id="tableChangeHistoryBody">  
            </tbody> 
        </table>
    </div> <!-- end tab /changeHistory -->

    <div role="tabpanel" class="tab-pane" id="ci360History">
        <table class="table table-striped"> 
            <thead> 
                <tr> 
                    <th>Time</th>  
                    <th>SessionId</th>
                    <th>Event</th>
                    <th>Details</th> 
                    <!--<th>Count</th>-->
                </tr> 
            </thead> 
            <tbody id="tableCi360HistoryBody">  
            </tbody> 
        </table>
    </div> <!-- end tab /ci360History -->

  </div>

</div>
<!-- tab navigation end -->

    <script id="ci360Row" type="text/x-handlebars-template">
        <tr>
            <td >{{eventTimestamp}}</td>
            <td >{{session}}</td>
            <td >{{event}}</td>
            <td width="50%">{{eventText}}</td> 
            <!--<td >{{count}}</td>-->            
        </tr>
    </script>

    <script id="sessionAllRow" type="text/x-handlebars-template">
        <tr>
            <td >{{timestamp}}</td>
            <td >{{sessionid}} <br>
                <p style="color: darkgoldenrod;">&nbsp;&nbsp;&nbsp;{{visitorid}}</p></td>
            <td >
                 {{#if oldidentity}}
                   <strike>{{oldidentity}}</strike><br><p style="{{css}}">{{identity}}</p></td>
                 {{else}} 
                   <p style="{{css}}">{{identity}}</p></td>
                 {{/if}}
            <td ><p style="{{css}}">{{piidata}}</p></td>          
        </tr>
    </script>

    <script id="eventAllRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td> 
            <td >{{eventText}}<br>{{uri}}</td>
            
        </tr>
    </script>

    <script id="eventClickRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td>
            <td >{{eventText}}<br>{{uri}}</td>
            
        </tr>
    </script>

    <script id="eventLoadRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td>
            <td >{{eventText}}<br>{{uri}}</td> 
        </tr>
    </script>

    <script id="eventChangeRow" type="text/x-handlebars-template">
        <tr class="{{colorClass}}">
            <td >{{eventTimestamp}}</td>
            <td >{{session}}<br>{{visitor}}</td>
            <td >{{event}}</td>
            <td >{{eventField}}</td> 
            <td >{{eventValue}}</td> 
            <td >{{uri}}</td>           
        </tr>
    </script>


    <script src="js/ext/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="js/ext/jquery-ui.js" type="text/javascript"></script>
    <script src="js/ext/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/ext/handlebars-4.0.5.min.js" type="text/javascript"></script>
    <script src="js/ext/holder.min.js" type="text/javascript"></script>
    <script src="js/inspector.js" type="text/javascript"></script>
    <script type="text/javascript">

    var exampleCustomerArray = [
{"identity":"761d434c-1a7c-4af4-89ea-23c70e477bd1",
"Name":"Mathias Bouten",
"Email":"mathias.bouten@sas.com",
"Age":"36",
"Gender":"Male",
"Segment":"Small-Family",
"Score":"77"},

{"identity":"08ee2c6f-47e0-3ccd-a21e-3241662de4bc",
"Name":"Mathias Bouten",
"Email":"mathias.bouten@sas.com",
"Age":"36",
"Gender":"Male",
"Segment":"Small-Family",
"Score":"77"},

{"identity":"c6a4ff06-1e8d-44df-9867-bfac85931692",
"Name":"Rob Sneath",
"Email":"rob.sneath@sas.com",
"Age":"41",
"Gender":"Male",
"Segment":"Just-Married",
"Score":"55"},

{"identity":"74f1ab8b-b090-4c86-a856-d1835cddbdcb",
"Name":"Rob Taylor",
"Email":"robj.taylor@sas.com",
"Age":"39",
"Gender":"Male",
"Segment":"Social-Shopper",
"Score":"60"}
];

    var defaultSettingsObject = {
        "adjustTimestamp":"7200000",
        "suppress_identity_event_email_id":"false",
        "suppress_identity_event_login_id":"false"
    };

    var htmlTemplates = {};
        $("script[type='text/x-handlebars-template']").each(function(elem) {
            htmlTemplates[this.id] = Handlebars.compile($(this).html());
        });

    var eventHistory = [];
    var aggrEvents = [];
    var sessionHistory = [];
    var demoCustomers = [];

    var adjustTime = 7200000;
    var suppress_identity_event_email_id = false;
    var suppress_identity_event_login_id = false;
    

    var relevantEvents = {"load": ["event", "page_title", "referrer", "uri", "^pe_*", "identity"], "click": ["event", "title", "uri", "targetInnerText", "anchor_href", "identity"], "change": ["event", "form\\.f\\.[\\w+|-]+$"], "submit": ["event", "form._h.name","form\\.f\\.[\\w+|-]+$"], "contentchange":["target", "value"], "IdentityEvent":["event", "title", "uri", "identity"]};
    var displayFullDetails = false;
    var eventsOrder = "newLast";

    if (!localStorage.getItem('CI360Customers')) {
        console.log("item does not exist, will be created");
        localStorage.setItem('CI360Customers', JSON.stringify(exampleCustomerArray));
    } else {
        demoCustomers = JSON.parse(localStorage.getItem('CI360Customers') ? localStorage.getItem('CI360Customers') : "[]");
    }

    if (!localStorage.getItem('CI360Settings')) {
        console.log("CI360Settings item does not exist, will be created");
        localStorage.setItem('CI360Settings', JSON.stringify(defaultSettingsObject));
    } else {
        settingsObject = JSON.parse(localStorage.getItem('CI360Settings') ? localStorage.getItem('CI360Settings') : "{}");
    }


    function updateEventHistoryDiagram() {
        var reverseHistory = eventHistory.slice(-5);
        reverseHistory.reverse();

        for(var i = 0; i < 5; i++) {
                
                var realSelectorId = (4-i);
                var cssSelector = ".event-bobble:eq("+ realSelectorId +")";
            
            if(i < eventHistory.length) {
                
                var realEventId = ((eventHistory.length - 1) -i );

                var eventText = "";

                if(reverseHistory[i].event == "load") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "360 Event </br>" + decodeURIComponent(reverseHistory[i].page_title);
                    } else {
                        eventText = "View Page </br>" + decodeURIComponent(reverseHistory[i].page_title);
                    }
                }
                else if(reverseHistory[i].event == "click") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "360 Event </br>" 
                          + (decodeURIComponent(reverseHistory[i].eventname)).trim().substr(0,15);
                    } else {
                        eventText = "Click on </br>" 
                          + (decodeURIComponent(reverseHistory[i].title ? reverseHistory[i].title : reverseHistory[i].targetInnerText)).trim().substr(0,15);
                    }
                }
                else if(reverseHistory[i].event == "change") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "360 Event </br>" 
                            + decodeURIComponent(reverseHistory[i]["eventname"]);

                    } else {
                        eventText = "Field Interaction";
                    }
                }
                else if(reverseHistory[i].event == "submit") {
                    if (reverseHistory[i].eventSource == "webmarketing") {
                        eventText = "360 Event </br>" 
                            + decodeURIComponent(reverseHistory[i]["eventname"]);
                    } else {
                        eventText = "Form Submit <br/>" + decodeURIComponent(reverseHistory[i]["form._h.name"]);
                    }
                }
                else if(reverseHistory[i].event == "contentchange") {
                    eventText = "Content Changed";
                } 
                else if(reverseHistory[i].event == "IdentityEvent") {
                    eventText = "Customer Login"
                }


                var maxTextLength = 50 - (i*5);

                $(cssSelector).html("<p>" + eventText.substr(0,maxTextLength) + "</p>");
                $(cssSelector).attr("onclick", "displayEventDetails(" + realEventId + ");" );
                    
            }
            else {
                $(cssSelector).html("<p>...</p>");
                $(cssSelector).attr("onclick", "void;" );    
            }
        }
    }

    function reorderEvents() {
        $('.classEventsOrder').removeClass("glyphicon glyphicon-chevron-up glyphicon-chevron-down");

        if (eventsOrder == "newFirst") {
            eventsOrder = "newLast";
            $('.classEventsOrder').addClass("glyphicon glyphicon-chevron-down");
        } else if (eventsOrder == "newLast") {
            eventsOrder = "newFirst";
            $('.classEventsOrder').addClass("glyphicon glyphicon-chevron-up");
        }
        updateEventHistoryTable();
    }


    function updateEventHistoryTable() {
        var reverseHistory = eventHistory.slice(-50);
        if (eventsOrder == "newFirst") {
            reverseHistory.reverse();
        } 
        
        $('#tableDetailedHistoryBody').html("");
        $('#tableClickHistoryBody').html("");
        $('#tableLoadHistoryBody').html("");
        $('#tableChangeHistoryBody').html("");
        $('#tableCi360HistoryBody').html("");

        for(var i = 0; i < 50; i++) {  //number of past events to display
            
            if(i < eventHistory.length) {
                
                var realEventId = ((eventHistory.length - 1) -i );

                var eventText = "";

                if(reverseHistory[i].event == "load") {
                    reverseHistory[i].eventText = decodeURIComponent(reverseHistory[i].page_title);
                }
                else if(reverseHistory[i].event == "click") {
                    reverseHistory[i].eventText = (decodeURIComponent(reverseHistory[i].title ? reverseHistory[i].title : reverseHistory[i].targetInnerText)).trim().substr(0,30);
                }
                else if(reverseHistory[i].event == "change") {
                    reverseHistory[i].eventText = decodeURIComponent(reverseHistory[i].location);
                    var indexFrom = reverseHistory[i].eventText.lastIndexOf("/")+1;
                    var field = reverseHistory[i].eventText.substr(indexFrom);
                    var value = decodeURIComponent(reverseHistory[i]["form.f."+field]);
                    reverseHistory[i].eventField = field;
                    reverseHistory[i].eventValue = value;
                    reverseHistory[i].eventText = field;
                }
                else if(reverseHistory[i].event == "submit") {
                    reverseHistory[i].eventText = "Form Id: " + decodeURIComponent(reverseHistory[i]["form._h.id"]) +", Form Name: " + decodeURIComponent(reverseHistory[i]["form._h.name"]);
                }
                else if(reverseHistory[i].event == "contentchange") {
                    reverseHistory[i].eventText = "Content Changed"; 
                }
                else if(reverseHistory[i].event == "IdentityEvent") {
                    eventText = "Identity Event"
                }


                var maxTextLength = 50 - (i*5);

                addEventRow(reverseHistory[i]);
            }
            
        }
        $('#infoEvents').html(eventHistory.length);
    }

    function updateSessionHistory() {
        $('#tableSessionHistoryBody').html("");
        for (sid in sessionHistory) {
            $('#tableSessionHistoryBody').append(htmlTemplates.sessionAllRow(sessionHistory[sid]));                  
        }

        lastSessionid = "";
        numberOfSessions = 0;
        for(s in sessionHistory) {
            if(sessionHistory[s].sessionid != lastSessionid) {
                numberOfSessions++;
                lastSessionid = sessionHistory[s].sessionid;
            }
        }


        $('#infoSessions').html(numberOfSessions);
        
    }

    function trackEvent(eventData) {

        updateUIAggregatedFields(eventData);

        // set login identifier array to suppress certain identifier events
        var login_identifier_to_suppress = [ ];
        if (settingsObject.suppress_identity_event_email_id == "true") {
            login_identifier_to_suppress.push( 'email_id' );
        } 
        if (settingsObject.login_identifier_to_suppress == "true") {
            login_identifier_to_suppress.push( 'login_id' );
        } 
        console.log("login_identifier_to_suppress: ", login_identifier_to_suppress);

        // store event only if it is relevant
        if(relevantEvents.hasOwnProperty(eventData.event)) {

            //todo: 3 login events fired by finance demo
            if (eventData.login_event_type != undefined 
                && login_identifier_to_suppress.indexOf( eventData.login_event_type ) > -1) {

                // don't capture event!!

            } else {

                if (settingsObject.adjustTimestamp != undefined) {
                    adjustTime = settingsObject.adjustTimestamp*1;
                }
                eventData.eventTimestamp = (new Date(eventData.timestamp*1+adjustTime)).toISOString().replace('T',' ').replace('Z','');
                eventHistory.push(eventData);

            
                // store onle last 15 events
                eventHistory = eventHistory.slice(-50);
                localStorage.setItem('CI360InspectorEvents', JSON.stringify(eventHistory));
                

                // update journey
                updateEventHistoryDiagram();
                updateEventHistoryTable();
                
                checkAndUpdateSession(eventData);

                // display details of last event
                var lastEventId = eventHistory.length - 1;
                displayEventDetails(lastEventId);

                $(".event-bobble:eq(4)").removeClass( "other", 500, "easeOutBounce" );
                $(".event-bobble:eq(4)").addClass( "other", 500, "easeOutBounce" );
            }
        
        }    
    }

    function aggregateEventHistory(eventHistory) {
        var aggrEvents = [];
        eventHistory.map(function(obj){
            eventFound = false;
            for (idx in aggrEvents) {
                if(aggrEvents[idx].eventname == decodeURIComponent(obj.eventname)) {
                    aggrEvents[idx].count = aggrEvents[idx].count+1;
                    eventFound = true;
                } 
            }
            if (eventFound == false && obj.eventname != undefined) {
                console.log("event not found ....inserting");
                aggrEvent = {};
                aggrEvent.eventname = decodeURIComponent(obj.eventname);
                aggrEvent.eventTimestamp = obj.eventTimestamp;
                aggrEvent.session = obj.session;
                aggrEvent.visitor = obj.visitor;
                aggrEvent.identity = obj.identity;
                aggrEvent.event = obj.event;
                aggrEvent.count = 1;
                aggrEvents.push(aggrEvent);
            }
        });
        return aggrEvents;
        
    }

    function addEventRow(lastEvent) {

        if (lastEvent.eventSource != undefined && lastEvent.eventSource == 'webmarketing') {
        } else {
            //todo

                $('#tableDetailedHistoryBody').append(htmlTemplates.eventAllRow(lastEvent));
            
        }

        if ((lastEvent.eventSource != undefined && lastEvent.eventSource == 'webmarketing')
             || lastEvent.event == "IdentityEvent" ) {
            //console.log("webmarketing event: ", lastEvent.event);
             
            lastEvent.eventText = lastEvent.event == "IdentityEvent" ? "Customer Login" : decodeURIComponent(lastEvent.eventname);
            lastEvent.eventname = decodeURIComponent(lastEvent.eventname);
            $('#tableCi360HistoryBody').append(htmlTemplates.ci360Row(lastEvent));

            /*aggrEvents.push(lastEvent);
            console.log("aggrEvents: ", aggrEvents);
            aggrHist = aggregateEventHistory(aggrEvents)
            localStorage.setItem('CI360InspectorAggrEvents', JSON.stringify(aggrHist));
            console.log(" aggrHist: ", aggrHist);
            aggrHist.map(function(lastEventx) {
                $('#tableCi360HistoryBody').append(htmlTemplates.ci360Row(lastEventx));
            });*/
        } else if (lastEvent.event == 'click') {
            lastEvent.colorClass = "success";
            $('#tableClickHistoryBody').append(htmlTemplates.eventClickRow(lastEvent));
        } else if (lastEvent.event == 'load') {
            lastEvent.colorClass = "info";
            $('#tableLoadHistoryBody').append(htmlTemplates.eventLoadRow(lastEvent));
        } else if (lastEvent.event == 'change') {
            lastEvent.colorClass = "active";
            $('#tableChangeHistoryBody').append(htmlTemplates.eventChangeRow(lastEvent));
        }       
    }

    function loadPreviousEvents() {
        sessionHistory = JSON.parse(localStorage.getItem('CI360InspectorSessions') ? localStorage.getItem('CI360InspectorSessions') : "[]");

        eventHistory = JSON.parse(localStorage.getItem('CI360InspectorEvents') ? localStorage.getItem('CI360InspectorEvents') : "[]");

        aggrEvents = JSON.parse(localStorage.getItem('CI360InspectorAggrEvents') ? localStorage.getItem('CI360InspectorAggrEvents') : "[]");

        for(eventId in eventHistory) {
            updateUIAggregatedFields(eventHistory[eventId], eventId);
        }
        // update journey
        updateEventHistoryDiagram();
        updateEventHistoryTable();
        updateSessionHistory();
    }



    function updateUIAggregatedFields(eventData) {
        $("#infoLastUpdate").html(timeConverter(parseInt(eventData.timestamp)));
        $("#infoLastEvent").html(decodeURIComponent(eventData["event"]));

        if(eventData.event === "load") {
            $("#infoIdentity").html(decodeURIComponent(eventData["identity"]));
            $("#infoVisitor").html(decodeURIComponent(eventData["visitor"]));
            $("#infoSession").html(decodeURIComponent(eventData["session"]));
            $("#infoSecurity").html(decodeURIComponent(eventData["protocol"]));
            $("#infoScreen").html(decodeURIComponent(eventData["screen_info"]));
            $("#infoBsz").html(decodeURIComponent(eventData["bsz"]));
            $("#infoLanguage").html(decodeURIComponent(eventData["browser_language"]));
            $("#infoPlatform").html(decodeURIComponent(eventData["platform"]));
            $("#infoCurrentPage").html(decodeURIComponent(eventData["page_title"]));
        }

        //update customer attributes
            var customer = getCustomer(eventData.identity);
            if (customer.identity != undefined) {
                $("#divCustAttr").html("");
                for (attr in customer) {
                    if(attr != "identity") {
                        $('#divCustAttr').append("<b>" +attr+":</b> "+customer[attr]+"<br/>");
                    }
                }
            }
    }



    function displayEventDetails(eventId) {
        var resultHtml = "<table class=\"table table-striped\">";
        for(prop in eventHistory[eventId]) {

            var isImportant = false;
            if(relevantEvents.hasOwnProperty(eventHistory[eventId].event)) {
                for (selector of relevantEvents[eventHistory[eventId].event]) {
                    var regEx = new RegExp(selector, "g");
                    isImportant = regEx.test(prop);
                    if(isImportant) {
                        break;
                    }
                }
            }
            resultHtml += "<tr class=\"" + (isImportant ? "highlighted" : "details") + "\" ><td>" + prop + " </td>  <td>" + decodeURIComponent(eventHistory[eventId][prop]) + "</td> </tr>";
        }

        resultHtml +="</table>";

        $("#eventDetails").html(resultHtml);
        if(!displayFullDetails) {
            $("tr.details").hide();
        }
    }


    function toggleFullDetails() {
        if(displayFullDetails) {
            displayFullDetails = false;
            $("tr.details").hide();
        } else {
            displayFullDetails = true;
            $("tr.details").show();
        }
    }

    function clearHistory(){
        eventHistory = [];
        sessionHistory = [];

        localStorage.setItem('CI360InspectorEvents', "[]");
        localStorage.setItem('CI360InspectorSessions', "[]");
        localStorage.setItem('CI360InspectorAggrEvents', "[]");
        $("#eventDetails").html("");
        updateEventHistoryDiagram();
        updateEventHistoryTable();
        updateSessionHistory();
        clearVisitorProfileFields();
        displayEmptyCustomerAttributes();
    }

    function clearVisitorProfileFields() {
        $(".custAttr").html("...");
    }

    function timeConverter(UNIX_timestamp){
        return (new Date(UNIX_timestamp)).toGMTString()
    }

    function parseData(dataString) {
        var pairs = dataString.split("&");
        var objects = pairs.map(function(item) { parts = item.split("="); if(parts.length > 0) { var obj = {}; obj[parts[0]] = parts.slice(1).join("="); return obj};})
        var result = objects.reduce(function(resultObj,currentValue,currentIndex,arr) { for(attr in currentValue) resultObj[attr] = currentValue[attr]; return resultObj}, {});
        return result;
    }


    function processCustomerAttributes(attributesObj) {
        for(attr in attributesObj) {
            console.log("Setting #"+attr+" to " +attributesObj[attr]);
            $("#" + attr).html(attributesObj[attr]);
            session.identity = attributesObj[attr];
            session.piidata = "None";

            //display customer attributes
            var customer = getCustomer(attributesObj[attr]);

            if (customer.identity != undefined) {
                $("#divCustAttr").html("");
                for (attr in customer) {
                    if(attr != "identity") {
                        $('#divCustAttr').append("<b>" +attr+":</b> "+customer[attr]+"<br/>");
                    }
                }
            }
        }
    }

    function checkAndUpdateSession(eventData) {
        //console.log("  check Session executed by " + caller);

        var session = {}; 
        session.sessionid = ""; 
        session.identity = "";
        session.css = "";
        session.piidata = "None";
        session.event = "default";
        session.updated = false;

        session.sessionid = eventData.session;
        session.visitorid = eventData.visitor;
        session.identity  = eventData.identity;
        session.timestamp = eventData.eventTimestamp;

        var lastSession = {};
        if (sessionHistory.length > 0) {
            lastSession = sessionHistory[sessionHistory.length-1];
        }   

        
        if(eventData.event == "IdentityEvent") {
            session.event = "IdentityEvent";
            session.piidata = decodeURIComponent(eventData.login_event);
            session.oldidentity = lastSession.identity;
            session.css = "color:orangered";
            sessionHistory.push(session);
            console.log(" identity event - adding record");
        } 
        else if(lastSession.event == "IdentityEvent" 
                && lastSession.oldidentity == lastSession.identity
                && lastSession.updated == false) {
            console.log("identity event updating....");
            sessionHistory[sessionHistory.length-1].identity = session.identity; 
            sessionHistory[sessionHistory.length-1].updated = true;
            
            // if old and new updated identity are equals then delete old
            if (sessionHistory[sessionHistory.length-1].identity == sessionHistory[sessionHistory.length-1].oldidentity) {
                sessionHistory[sessionHistory.length-1].oldidentity = "";
            }
            
            // update sessionHistory Array
            for (idx in sessionHistory) {
                if (sessionHistory[idx].identity == lastSession.oldidentity
                    && sessionHistory[idx].updated == false) {
                    sessionHistory[idx].oldidentity = sessionHistory[idx].identity;
                    sessionHistory[idx].identity = session.identity;
                    sessionHistory[idx].updated = true;
                }
            }            
        }

        else if (session.sessionid != undefined && session.sessionid.length > 0) {

            var isNotSameSession = true;
            for (sid in sessionHistory) {
                if(session.sessionid == sessionHistory[sid].sessionid) {
                    isNotSameSession = false;
                }       
            }

            if(isNotSameSession == true) {
                console.log("!!! is not same session...adding new session !!!");
                sessionHistory.push(session);
            } 
            
        }
        localStorage.setItem('CI360InspectorSessions', JSON.stringify(sessionHistory));
        updateSessionHistory();
        
    }

    function getCustomer(customerIdentifier) {
        var returnCustomerObj = {};
        for (customerIndex in demoCustomers) {
            customer = demoCustomers[customerIndex];
            if (customer.identity == customerIdentifier) {
                returnCustomerObj = customer;
                break;
            }
        }
        return returnCustomerObj;
    }

    function displayPopup() {
        
        // get Customer Object
        if (!localStorage.getItem('CI360Customers')) {
            console.log("item does not exist");
        } else {
            demoCustomers = JSON.parse(localStorage.getItem('CI360Customers') ? localStorage.getItem('CI360Customers') : "[]");
            customerString = JSON.stringify(demoCustomers).replace(/,/g,",\n").replace(/{/g,"\n{").replace(/]/g,"\n]");
            $('#textareaCustomers').val(customerString);
        }

        // get Settings Object
        if (!localStorage.getItem('CI360Settings')) {
            console.log("CI360Settings item does not exist");
        } else {
            settingsObject = JSON.parse(localStorage.getItem('CI360Settings') ? localStorage.getItem('CI360Settings') : "{}");
            settingsString = JSON.stringify(settingsObject).replace(/,/g,",\n").replace(/{/g,"{\n").replace(/]/g,"\n]").replace(/}/g,"\n}");
            $('#textareaSettings').val(settingsString);
        }
    }

    function displayEmptyCustomerAttributes() {
        demoCustomers = JSON.parse(localStorage.getItem('CI360Customers') ? localStorage.getItem('CI360Customers') : "[]");

        $('#divCustAttr').html("");
        for (attr in demoCustomers[0]) {
            if(attr != "identity") {
                $('#divCustAttr').append("<b>" +attr+":</b> ...<br/>");
            }
        }
    }

    function saveCustomerObj() {
        var demoCustomers = $('#textareaCustomers').val();
        var settingsObject = $('#textareaSettings').val();
        localStorage.setItem('CI360Customers', demoCustomers);
        localStorage.setItem('CI360Settings', settingsObject);
    }


    $( document ).ready(function() {
        
        loadPreviousEvents();
        displayEmptyCustomerAttributes();

        window.addEventListener('message', function(event) {
            // The data sent with postMessage is stored in event.data
            console.log("Recieved Event from CI360...");

            if(event.data !== undefined && event.data.type !== undefined) {
                //console.dir(parseData(event.data.payload));

                if(event.data.type == "tracking") {
                    trackEvent(parseData(event.data.payload));
                }

                else if(event.data.type == "heartbeat") {
                    console.log("Communication to main window established.");
                }

                else if(event.data.type == "customer-attribute") {
                    //console.log("Getting customer attribute: "); 
                    //console.dir(parseData(event.data.payload));
                    processCustomerAttributes(parseData(event.data.payload));
                }

                else if(event.data.type == "customer-login") {
                    
                }
                
            } else {
                console.log("No data received");
            }
            
        });
    });
    </script>
  </body>
</html>


